<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-bedwetter/node_modules/bedwetter/lib/actions/add.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-bedwetter">npmtest-bedwetter (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-bedwetter/node_modules/bedwetter/lib/actions/add.js</span></h1>
    <h2>
        
        Statements: <span class="metric">8.97% <small>(7 / 78)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 47)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 10)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">10% <small>(7 / 70)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-bedwetter/node_modules/bedwetter/lib/actions/</a> &#187; add.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Module dependencies
 */
var _ = require('lodash');
var Boom = require('boom');
var Hoek = require('hoek');
var Async = require('async');
var WL2Boom = require('waterline-to-boom');
var GeneralUtil = require('../generalUtil');
&nbsp;
/**
 * Add Record To Collection
 *
 * post  /:modelIdentity/:id/:collectionAttr/:childid
 *
 * Associate one record with the collection attribute of another.
 * e.g. add a Horse named "Jimmy" to a Farm's "animals".
 * If the record being added has a primary key value already, it will
 * just be linked.  If it doesn't, a new record will be created, then
 * linked appropriately.  In either case, the association is bidirectional.
 *
 */
&nbsp;
module.exports = <span class="fstat-no" title="function not covered" >function addToCollection (route, origOptions) {</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  return <span class="fstat-no" title="function not covered" >function (request, reply) {</span></span>
    
    // Transform the original options using options hook
<span class="cstat-no" title="statement not covered" >    var options = GeneralUtil.applyOptionsHook(request, origOptions);</span>
    
<span class="cstat-no" title="statement not covered" >    var RequestState = request.plugins.bedwetter = {</span>
      action: 'add',
      options: options
    };
    
<span class="cstat-no" title="statement not covered" >    var actionUtil = require('../actionUtil')(request, options);</span>
    
    // Ensure a model and alias can be deduced from the request.
<span class="cstat-no" title="statement not covered" >    var Model = actionUtil.parseModel();</span>
<span class="cstat-no" title="statement not covered" >    var relation = options.associationAttr;</span>
    
<span class="cstat-no" title="statement not covered" >    if (!relation) {</span>
<span class="cstat-no" title="statement not covered" >      return reply(Boom.wrap(new Error('Missing required route option, `options.associationAttr`.')));</span>
    }
&nbsp;
    // The primary key of the parent record
<span class="cstat-no" title="statement not covered" >    var parentPk;</span>
    
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      parentPk = actionUtil.requirePk();</span>
    } catch(e) {
<span class="cstat-no" title="statement not covered" >      return reply(Boom.wrap(e)); </span>
    }
  
    // Get the model class of the child in order to figure out the name of
    // the primary key attribute.
    
<span class="cstat-no" title="statement not covered" >    var associationAttr = _.findWhere(options.associations, { alias: relation });</span>
<span class="cstat-no" title="statement not covered" >    Hoek.assert(_.isObject(associationAttr), 'Bad association.');</span>
    
<span class="cstat-no" title="statement not covered" >    var ChildModel = request.model[associationAttr.collection];</span>
<span class="cstat-no" title="statement not covered" >    var childPkAttr = ChildModel.primaryKey;</span>
  
  
    // The child record to associate is defined by either...
<span class="cstat-no" title="statement not covered" >    var child;</span>
  
    // ...a primary key:
<span class="cstat-no" title="statement not covered" >    var supposedChildPk = actionUtil.parsePk(true);</span>
    
    // ...or an object of values:
<span class="cstat-no" title="statement not covered" >    if (!supposedChildPk)  { </span>
      
<span class="cstat-no" title="statement not covered" >      options.values = options.values || {};</span>
<span class="cstat-no" title="statement not covered" >      options.values.blacklist = options.values.blacklist || [];</span>
      // Make sure nobody can specify the id of the child.
      
      // You either link a record with the id in the URL or create an enitrely new record without specifying the id!
<span class="cstat-no" title="statement not covered" >      options.values.blacklist.push(childPkAttr);</span>
<span class="cstat-no" title="statement not covered" >      child = actionUtil.parseValues(true);</span>
      
    }
  
<span class="cstat-no" title="statement not covered" >    if (!child &amp;&amp; !supposedChildPk) {</span>
<span class="cstat-no" title="statement not covered" >      return reply(Boom.badRequest('You must specify the record to add (either the primary key of an existing record to link, or a new object without a primary key which will be used to create a record then link it.)'));</span>
    }
  
<span class="cstat-no" title="statement not covered" >    var createdChild = false;</span>
  
<span class="cstat-no" title="statement not covered" >    Async.auto({</span>
  
      // Look up the parent record
      parent: <span class="fstat-no" title="function not covered" >function (cb) {</span>
        
<span class="cstat-no" title="statement not covered" >        Model.findOne(parentPk).exec(<span class="fstat-no" title="function not covered" >function foundParent(err, parentRecord) {</span></span>
          
<span class="cstat-no" title="statement not covered" >          if (err) <span class="cstat-no" title="statement not covered" >return cb(err);</span></span>
<span class="cstat-no" title="statement not covered" >          if (!parentRecord) <span class="cstat-no" title="statement not covered" >return cb(Boom.notFound());</span></span>
<span class="cstat-no" title="statement not covered" >          if (!actionUtil.validOwnership(parentRecord, false)) <span class="cstat-no" title="statement not covered" >return cb(Boom.unauthorized());</span></span>
<span class="cstat-no" title="statement not covered" >          if (!parentRecord[relation] || !parentRecord[relation].add) <span class="cstat-no" title="statement not covered" >return cb(Boom.notFound());</span></span>
                    
<span class="cstat-no" title="statement not covered" >          cb(null, parentRecord);</span>
          
        });
      },
  
      // If a primary key was specified in the `child` object we parsed
      // from the request, look it up to make sure it exists.  Send back its primary key value.
      // This is here because, although you can do this with `.save()`, you can't actually
      // get ahold of the created child record data, unless you create it first.
      actualChild: ['parent', <span class="fstat-no" title="function not covered" >function(cb) {</span>
  
        // Below, we use the primary key attribute to pull out the primary key value
        // (which might not have existed until now, if the .add() resulted in a `create()`)
  
        // If the primary key was specified for the child record, we should try to find it
<span class="cstat-no" title="statement not covered" >        if (supposedChildPk) {</span>
          
<span class="cstat-no" title="statement not covered" >          ChildModel.findOne(supposedChildPk).exec(<span class="fstat-no" title="function not covered" >function foundChild(err, childRecord) {</span></span>
            
<span class="cstat-no" title="statement not covered" >            if (err) <span class="cstat-no" title="statement not covered" >return cb(err);</span></span>
            
            // Trying to associate a record that does not exist
<span class="cstat-no" title="statement not covered" >            if (!childRecord)</span>
<span class="cstat-no" title="statement not covered" >              return cb(Boom.notFound());</span>
            
<span class="cstat-no" title="statement not covered" >            if (!actionUtil.validOwnership(childRecord, true))</span>
<span class="cstat-no" title="statement not covered" >              return cb(Boom.unauthorized());</span>
            
            // Otherwise use the one we found.
<span class="cstat-no" title="statement not covered" >            return cb(null, childRecord);</span>
          });
          
        } else { // Otherwise, it must be referring to a new thing, so create it.
          
<span class="cstat-no" title="statement not covered" >          ChildModel.create(child).exec(<span class="fstat-no" title="function not covered" >function createdNewChild (err, newChildRecord) {</span></span>
            
<span class="cstat-no" title="statement not covered" >            if (err) <span class="cstat-no" title="statement not covered" >return cb(err);</span></span>
<span class="cstat-no" title="statement not covered" >            createdChild = true;</span>
            
<span class="cstat-no" title="statement not covered" >            return cb(null, newChildRecord);</span>
          });
          
        }
        
      }],
  
      // Add the child record to the parent's collection
      add: ['parent', 'actualChild', <span class="fstat-no" title="function not covered" >function(cb, asyncData) {</span>
        
<span class="cstat-no" title="statement not covered" >        try {</span>
          
          // `collection` is the parent record's collection we
          // want to add the child to.
<span class="cstat-no" title="statement not covered" >          var collection = asyncData.parent[relation];</span>
<span class="cstat-no" title="statement not covered" >          collection.add(asyncData.actualChild[childPkAttr]);</span>
          
<span class="cstat-no" title="statement not covered" >          return cb();</span>
        
        } catch (err) {
          
          // TODO: could all this be simplified?  do we need try/catch for record.add?
          // I think not.  It's just an Array.push: https://github.com/balderdashy/waterline/blob/4653f8a18016d2bcde9a70c90dd63a7c69381935/lib/waterline/model/lib/association.js
          // On the flipside, what if this relation doesn't exist?  Test!!  Should this err be turned into a notFound, similarly to in the parent function?
          // Okay now this relation is properly tested for in the parent function
<span class="cstat-no" title="statement not covered" >          if (err) {</span>
<span class="cstat-no" title="statement not covered" >            return cb(err);</span>
          }
          
<span class="cstat-no" title="statement not covered" >          return cb();</span>
        }
        
      }]
    },
  
    // Finally, save the parent record
<span class="fstat-no" title="function not covered" >    function readyToSave (err, asyncResults) {</span>
  
<span class="cstat-no" title="statement not covered" >      if (err) <span class="cstat-no" title="statement not covered" >return reply(WL2Boom(err));</span></span>
      
<span class="cstat-no" title="statement not covered" >      asyncResults.parent.save(<span class="fstat-no" title="function not covered" >function saved(err, savedParent) {</span></span>
  
        // Ignore `insert` errors for duplicate adds, as add is idempotent.
<span class="cstat-no" title="statement not covered" >        var isDuplicateInsertError = (err &amp;&amp; typeof err === 'object' &amp;&amp; err.length &amp;&amp; err[0] &amp;&amp; err[0].type === 'insert');</span>
<span class="cstat-no" title="statement not covered" >        if (err &amp;&amp; !isDuplicateInsertError) <span class="cstat-no" title="statement not covered" >return reply(WL2Boom(err));</span></span>
        
        // Share primary record
<span class="cstat-no" title="statement not covered" >        RequestState.primaryRecord = asyncResults.parent;</span>
        
<span class="cstat-no" title="statement not covered" >        if (createdChild) {</span>
          
<span class="cstat-no" title="statement not covered" >          var location = actionUtil.getCreatedLocation(asyncResults.actualChild[childPkAttr]);</span>
          
          // Omit fields if necessary
<span class="cstat-no" title="statement not covered" >          actionUtil.omitFields(asyncResults.actualChild);</span>
          
<span class="cstat-no" title="statement not covered" >          return reply(asyncResults.actualChild).created(location);</span>
        
        } else {
          
          // Share secondary record
<span class="cstat-no" title="statement not covered" >          RequestState.secondaryRecord = asyncResults.actualChild;</span>
          
          // "HTTP 204 / No Content" means success
<span class="cstat-no" title="statement not covered" >          return reply().code(204);</span>
        }
        
      });
  
    }); // end async.auto
    
  }
  
};
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Fri Apr 21 2017 10:35:26 GMT+0000 (UTC)</div>
</div>
</body>
</html>
